# Paimon Yield Protocol - OTC 购买与时间窗口管理方案

## 问题背景

### 业务需求
1. **OTC 购买替代 DEX**：BSC 上 RWA token 池子太小，滑点大，需要从项目方 OTC 购买
2. **HYD Token 特殊性**：
   - 60% 配置到 HYD（链下基金）
   - 每月15号出净值
   - 买入到计息有 15-45 天延迟
   - 可以最后一天打款（如14号换成 HYD）
3. **时间窗口管理**：各资产申购时间不确定，需要灵活管理

### 当前合约差距
| 需求 | 当前状态 | 差距 |
|------|---------|------|
| OTC 购买 | ❌ 只有 DEX (SwapHelper) | 完全不支持 |
| 申购时间窗口 | ❌ 无 | 无时间调度机制 |
| 资产中间状态 | ⚠️ 只有 isActive + markedForRemoval | 缺少申购中/待结算状态 |
| 链下基金净值 | ⚠️ Oracle 只支持链上数据源 | 需要手动/定期更新机制 |
| 临时资产配置 | ⚠️ 固定 targetAllocation | 缺少动态切换机制 |

---

## 待确认问题

- [ ] OTC 购买流程：纯链下/链上/混合？
- [ ] HYD 净值更新方式：链下/Oracle/手动？
- [ ] 临时资产类型：USDT/其他RWA/都有？
- [ ] 时间管理方式：动态确认/周期浮动/手动触发？

---

## 初步方案架构（待用户确认后细化）

### 核心思路：链下调度 + 链上执行

```
┌─────────────────────────────────────────────────────────────────┐
│                     链下调度层 (Off-chain)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ OTC 订单管理 │  │ 时间窗口计算 │  │ 净值获取    │             │
│  │ (与项目方协商)│  │ (申购日历)   │  │ (每月15号)  │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
└─────────┼────────────────┼────────────────┼─────────────────────┘
          │                │                │
          ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     链上执行层 (On-chain)                        │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                 PNGYVault (扩展)                          │   │
│  │  ┌───────────────┐  ┌───────────────┐  ┌──────────────┐│   │
│  │  │ OTCManager    │  │ AssetScheduler│  │ NAVManager   ││   │
│  │  │ - 记录 OTC 订单│  │ - 申购状态    │  │ - 手动净值   ││   │
│  │  │ - 确认交割    │  │ - 到期提醒    │  │ - 定期更新   ││   │
│  │  └───────────────┘  └───────────────┘  └──────────────┘│   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 新增合约/模块

1. **OTCManager** - 管理 OTC 订单生命周期
2. **AssetScheduler** - 资产申购时间窗口管理
3. **ManualNAVOracle** - 支持手动设置链下基金净值

---

## 下一步

等待用户回答确认问题后，将细化具体实现方案。
