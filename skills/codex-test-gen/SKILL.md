---
name: codex-test-gen
description: Codex 测试生成 Agent - 为 Claude Code 的实现生成全面的测试用例
backend: codex
trigger: auto
priority: high
---

# Codex Test Generator

## 职责

为 Claude Code 的实现生成**高质量、全覆盖**的测试用例。

**核心原则**：测试是第二道防线，必须覆盖 Claude Code 可能遗漏的边界。

---

## 触发条件

1. **命令绑定**：`/ultra-test` 执行时自动触发
2. **GREEN Phase 后**：TDD 流程中 GREEN 阶段完成后
3. **手动触发**：用户请求生成测试

---

## 测试维度（6D 覆盖）

### 1. 功能测试 (Functional)

```typescript
// 验证核心功能正确性
describe('UserService', () => {
  it('should create user with valid data', async () => {
    const user = await service.create({ name: 'Test', email: 'test@test.com' });
    expect(user.id).toBeDefined();
    expect(user.name).toBe('Test');
  });
});
```

### 2. 边界测试 (Boundary)

```typescript
// 验证边界条件处理
describe('pagination', () => {
  it('should handle page=0', () => { /* ... */ });
  it('should handle page=MAX_INT', () => { /* ... */ });
  it('should handle negative page', () => { /* ... */ });
  it('should handle empty result set', () => { /* ... */ });
});
```

### 3. 异常测试 (Exception)

```typescript
// 验证错误处理
describe('error handling', () => {
  it('should throw ValidationError for invalid email', async () => {
    await expect(service.create({ email: 'invalid' }))
      .rejects.toThrow(ValidationError);
  });

  it('should handle database connection failure', async () => {
    mockDb.connect.mockRejectedValue(new Error('Connection failed'));
    await expect(service.create(validData))
      .rejects.toThrow('Database unavailable');
  });
});
```

### 4. 性能测试 (Performance)

```typescript
// 验证性能基准
describe('performance', () => {
  it('should process 1000 items within 100ms', async () => {
    const start = Date.now();
    await service.batchProcess(items1000);
    expect(Date.now() - start).toBeLessThan(100);
  });
});
```

### 5. 安全测试 (Security)

```typescript
// 验证安全防护
describe('security', () => {
  it('should reject SQL injection attempts', async () => {
    const malicious = "'; DROP TABLE users; --";
    await expect(service.findByName(malicious))
      .rejects.toThrow('Invalid input');
  });

  it('should sanitize XSS in user input', () => {
    const input = '<script>alert("xss")</script>';
    const sanitized = service.sanitize(input);
    expect(sanitized).not.toContain('<script>');
  });
});
```

### 6. 兼容性测试 (Compatibility)

```typescript
// 验证跨环境兼容
describe('compatibility', () => {
  it('should work with Node 18', () => { /* ... */ });
  it('should work with Node 20', () => { /* ... */ });
  it('should handle different timezones', () => { /* ... */ });
});
```

---

## 执行流程

```
Step 1: 分析实现代码
        - 提取函数签名
        - 识别分支路径
        - 检测外部依赖
        ↓
Step 2: 生成测试策略
        - 确定测试维度优先级
        - 规划 Mock 策略
        - 设计测试数据
        ↓
Step 3: 调用 Codex 生成测试
        ↓
Step 4: 验证测试质量
        - TAS 评分 ≥ 70
        - 覆盖率检查
        ↓
Step 5: 输出测试文件
```

---

## Codex 调用模板

```bash
codex -q --json <<EOF
你是一个测试专家。为以下代码生成全面的测试用例：

实现代码：
\`\`\`typescript
{implementation_code}
\`\`\`

要求：
1. 覆盖所有公开方法
2. 覆盖所有分支路径
3. 包含 6 个维度的测试：
   - Functional: 核心功能
   - Boundary: 边界条件（null, empty, max, min）
   - Exception: 错误处理
   - Performance: 性能基准（如适用）
   - Security: 安全防护（输入验证、注入防护）
   - Compatibility: 兼容性（如适用）

4. Mock 策略：
   - 只 Mock 外部依赖（数据库、API、文件系统）
   - 不要 Mock 内部模块
   - Mock 比例 ≤ 30%

5. 断言要求：
   - 使用行为断言（toBe, toEqual, toThrow）
   - 避免 Mock 断言（toHaveBeenCalled 仅作为辅助）
   - 每个测试至少 1 个有意义的断言

输出完整的测试文件代码。
EOF
```

---

## 输出格式

```typescript
// {filename}.test.ts
// Generated by Codex Test Generator
// Dimensions: Functional, Boundary, Exception, Security

import { describe, it, expect, beforeEach, vi } from 'vitest';
import { TargetClass } from './target';

describe('TargetClass', () => {
  let instance: TargetClass;

  beforeEach(() => {
    instance = new TargetClass();
  });

  // ========== Functional Tests ==========
  describe('core functionality', () => {
    it('should ...', () => { /* ... */ });
  });

  // ========== Boundary Tests ==========
  describe('boundary conditions', () => {
    it('should handle null input', () => { /* ... */ });
    it('should handle empty array', () => { /* ... */ });
    it('should handle max value', () => { /* ... */ });
  });

  // ========== Exception Tests ==========
  describe('error handling', () => {
    it('should throw on invalid input', () => { /* ... */ });
  });

  // ========== Security Tests ==========
  describe('security', () => {
    it('should prevent injection', () => { /* ... */ });
  });
});
```

---

## 质量门槛

| 指标 | 要求 |
|------|------|
| TAS (Test Authenticity Score) | ≥ 70% |
| 覆盖率 | ≥ 80% |
| Mock 比例 | ≤ 30% |
| 空测试 | 0 |
| 重言测试 | 0 |

---

## 与 Claude Code 的协作

```
Claude Code RED (写失败测试)
        ↓
Claude Code GREEN (实现通过)
        ↓
Codex 补充测试 (边界、异常、安全)
        ↓
运行全部测试
        ↓
覆盖率 < 80%? → Codex 补充更多测试
        ↓
Claude Code REFACTOR
```

---

## 配置

```json
{
  "codex-test-gen": {
    "minCoverage": 80,
    "minTAS": 70,
    "maxMockRatio": 0.3,
    "dimensions": ["functional", "boundary", "exception", "security"],
    "testFramework": "vitest",
    "outputPattern": "{filename}.test.ts"
  }
}
```

---

## 示例交互

**输入**：Claude Code 实现了 `UserService.create()` 方法

**Codex 生成输出**：

```typescript
// user-service.test.ts
describe('UserService.create', () => {
  // Functional
  it('should create user with valid data', async () => {
    const user = await service.create(validUserData);
    expect(user.id).toBeDefined();
    expect(user.email).toBe(validUserData.email);
  });

  // Boundary
  it('should handle name at max length (255 chars)', async () => {
    const user = await service.create({ ...validUserData, name: 'a'.repeat(255) });
    expect(user.name.length).toBe(255);
  });

  it('should reject name exceeding max length', async () => {
    await expect(service.create({ ...validUserData, name: 'a'.repeat(256) }))
      .rejects.toThrow('Name too long');
  });

  // Exception
  it('should throw on duplicate email', async () => {
    await service.create(validUserData);
    await expect(service.create(validUserData))
      .rejects.toThrow('Email already exists');
  });

  // Security
  it('should hash password before storing', async () => {
    const user = await service.create({ ...validUserData, password: 'secret' });
    expect(user.password).not.toBe('secret');
    expect(user.password).toMatch(/^\$2[aby]?\$/); // bcrypt pattern
  });
});
```
